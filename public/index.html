<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker ç›‘æ§é¢æ¿</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eâš¡%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { 
            --primary: #F38020; 
            --bg: #f3f4f6; 
            --card: #ffffff; 
            --text: #1f2937; 
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --progress-bg: #e5e7eb;
            --shadow: rgba(0,0,0,0.05);
            --btn-bg: #fff;
            --btn-hover: #f9fafb;
            --stat-value: #111827;
        }
        
        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --progress-bg: #374151;
            --shadow: rgba(0,0,0,0.3);
            --btn-bg: #374151;
            --btn-hover: #4b5563;
            --stat-value: #f9fafb;
        }
        
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .header h1 { 
            margin: 0; 
            font-size: 24px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .last-update { 
            font-size: 13px; 
            color: var(--text-secondary); 
            background: var(--border); 
            padding: 6px 12px; 
            border-radius: 20px; 
        }
        
        .theme-toggle {
            background: var(--btn-bg);
            border: 1px solid var(--border);
            padding: 8px 12px; 
            border-radius: 20px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px var(--shadow);
        }

        .quota-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
            margin-bottom: 24px; 
            border-left: 5px solid var(--primary); 
        }
        .quota-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-weight: 600; 
            font-size: 16px; 
        }
        .progress-bg { 
            height: 20px; 
            background: var(--progress-bg); 
            border-radius: 10px; 
            overflow: hidden; 
            position: relative; 
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #F38020, #f9a056); 
            width: 0%; 
            transition: width 1s ease; 
            border-radius: 10px; 
        }
        .quota-text { 
            display: flex; 
            justify-content: space-between; 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 6px; 
        }

        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { 
            border: 1px solid var(--border); 
            background: var(--btn-bg); 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            color: var(--text-secondary); 
            transition: all 0.2s; 
            box-shadow: 0 1px 2px var(--shadow); 
        }
        .btn.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 500; 
            border-color: var(--primary);
        }
        .btn:hover:not(.active) { 
            background: var(--btn-hover); 
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .stat-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
        }
        .stat-title { 
            color: var(--text-secondary); 
            font-size: 13px; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .stat-value { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--stat-value); 
        }
        .text-green { color: #10b981; } 
        .text-red { color: #ef4444; }

        #chart-container { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
            height: 450px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span style="color: var(--primary)">âš¡</span> Cloudflare Worker ç›‘æ§</h1>
            <div class="header-right">
                <span id="update-time" class="last-update">è½½å…¥ä¸­...</span>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
            </div>
        </div>

        <div class="quota-card">
            <div class="quota-header">
                <span>ä»Šæ—¥è¯·æ±‚ç”¨é‡ (UTC)</span>
                <span id="quota-percent">0%</span>
            </div>
            <div class="progress-bg">
                <div id="quota-bar" class="progress-bar"></div>
            </div>
            <div class="quota-text">
                <span id="quota-detail">0 / 100,000</span>
                <span>é‡ç½®æ—¶é—´: 00:00 UTC</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn active" onclick="setRange('24h')">æœ€è¿‘ 24 å°æ—¶</button>
            <button class="btn" onclick="setRange('7d')">æœ€è¿‘ 7 å¤©</button>
            <button class="btn" onclick="setRange('30d')">æœ€è¿‘ 30 å¤©</button>
        </div>

        <div class="grid">
            <div class="stat-card">
                <div class="stat-title">åŒºé—´æ€»è¯·æ±‚æ•°</div>
                <div class="stat-value" id="disp-req">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">åŒºé—´é”™è¯¯æ•°</div>
                <div class="stat-value text-red" id="disp-err">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">å¹³å‡æ¯å°æ—¶è¯·æ±‚</div>
                <div class="stat-value" id="disp-avg">-</div>
            </div>
        </div>

        <div id="chart-container"></div>
    </div>

    <script>
        // ==========================================
        // 1. æ— çŠ¶æ€ä¸»é¢˜ç³»ç»Ÿ (çº¯å†…å­˜ï¼Œåˆ·æ–°å³é‡ç½®)
        // ==========================================
        
        // å…¨å±€å˜é‡ï¼Œè®°å½•å½“å‰ä¸»é¢˜çŠ¶æ€
        // é¡µé¢åˆ·æ–°æ—¶ï¼ŒJSé‡æ–°åŠ è½½ï¼Œæ­¤å˜é‡ä¼šè¢«é‡ç½®
        var currentTheme = getThemeByTime();

        // æ ¹æ®æ—¶é—´åˆ¤æ–­åˆå§‹ä¸»é¢˜
        function getThemeByTime() {
            var hour = new Date().getHours();
            // 8ç‚¹åˆ°20ç‚¹æ˜¯ç™½å¤©(light)ï¼Œå¦åˆ™æ˜¯æ™šä¸Š(dark)
            return (hour >= 8 && hour < 20) ? 'light' : 'dark';
        }

        // åº”ç”¨ä¸»é¢˜åˆ° DOM
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            var toggle = document.getElementById('theme-toggle');
            if (toggle) {
                toggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
            // åŒæ­¥æ›´æ–°å…¨å±€å˜é‡
            currentTheme = theme;
        }

        // åˆ‡æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        function toggleTheme() {
            // å–åå½“å‰ä¸»é¢˜
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            // åº”ç”¨æ–°ä¸»é¢˜ (ä»…åœ¨å†…å­˜ä¸­ç”Ÿæ•ˆï¼Œä¸ä¿å­˜åˆ° localStorage)
            applyTheme(newTheme);
            
            // ç«‹å³é‡ç»˜å›¾è¡¨ä»¥é€‚é…æ–°é¢œè‰²
            if (chartInstance && currentLabels.length > 0) {
                renderChart(currentLabels, currentReqData, currentErrData, currentRange);
            }
        }

        // å®šæ—¶æ£€æŸ¥ï¼šé˜²æ­¢ç”¨æˆ·é•¿æ—¶é—´æŒ‚æœºè·¨è¶Šäº† 8:00 æˆ– 20:00
        // æ³¨æ„ï¼šè¿™é‡Œçš„é€»è¾‘æ˜¯ï¼Œå¦‚æœæ—¶é—´åˆ°äº†è‡ªåŠ¨åˆ‡æ¢ç‚¹ï¼Œä¼šè‡ªåŠ¨è¦†ç›–ç”¨æˆ·çš„æ‰‹åŠ¨è®¾ç½®
        function scheduleNextSwitch() {
            var now = new Date();
            var hour = now.getHours();
            var nextSwitchTime = new Date(now);
            var targetTheme;

            if (hour < 8) {
                // ä¸‹ä¸€æ¬¡åˆ‡æ¢æ˜¯æ—©ä¸Š 8 ç‚¹ -> å˜äº®
                nextSwitchTime.setHours(8, 0, 0, 0);
                targetTheme = 'light';
            } else if (hour < 20) {
                // ä¸‹ä¸€æ¬¡åˆ‡æ¢æ˜¯æ™šä¸Š 20 ç‚¹ -> å˜æš—
                nextSwitchTime.setHours(20, 0, 0, 0);
                targetTheme = 'dark';
            } else {
                // ä¸‹ä¸€æ¬¡åˆ‡æ¢æ˜¯æ˜å¤©æ—©ä¸Š 8 ç‚¹ -> å˜äº®
                nextSwitchTime.setDate(nextSwitchTime.getDate() + 1);
                nextSwitchTime.setHours(8, 0, 0, 0);
                targetTheme = 'light';
            }

            var msUntilSwitch = nextSwitchTime.getTime() - now.getTime();
            // é˜²æ­¢è®¡ç®—å‡ºçš„æ—¶é—´æ˜¯è´Ÿæ•°æˆ–0
            if (msUntilSwitch <= 0) msUntilSwitch = 1000; 

            setTimeout(function() {
                // æ—¶é—´åˆ°äº†ï¼Œæ‰§è¡Œè‡ªåŠ¨åˆ‡æ¢
                applyTheme(targetTheme);
                // æ›´æ–°å›¾è¡¨
                if (chartInstance) renderChart(currentLabels, currentReqData, currentErrData, currentRange);
                // é€’å½’è°ƒç”¨ï¼Œé¢„çº¦ä¸‹ä¸€æ¬¡åˆ‡æ¢
                scheduleNextSwitch();
            }, msUntilSwitch);
        }

        // ==========================================
        // 2. åˆå§‹åŒ–æ‰§è¡Œ
        // ==========================================
        
        // é¡µé¢åŠ è½½æ—¶ç«‹å³åº”ç”¨åŸºäºæ—¶é—´çš„ä¸»é¢˜
        applyTheme(currentTheme);
        
        // å¯åŠ¨å®šæ—¶å™¨
        scheduleNextSwitch();


        // ==========================================
        // 3. æ•°æ®ä¸å›¾è¡¨é€»è¾‘ (ä¿æŒä¸å˜)
        // ==========================================
        var rawData = [];
        var chartInstance = null;
        var currentRange = '24h';
        var currentLabels = [];
        var currentReqData = [];
        var currentErrData = [];
        var DAILY_LIMIT = 100000;

        function init() {
            refreshData();
        }

        function refreshData() {
            // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            fetch('./data.json?t=' + new Date().getTime())
                .then(function(res) {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(function(jsonResponse) {
                    // å…¼å®¹ç›´æ¥æ•°ç»„æˆ–å¯¹è±¡æ ¼å¼
                    rawData = Array.isArray(jsonResponse) ? jsonResponse : jsonResponse.data;

                    if (jsonResponse.updatedAt) {
                        var serverTime = new Date(jsonResponse.updatedAt);
                        document.getElementById('update-time').innerText = 'æ•°æ®æ›´æ–°äº: ' + serverTime.toLocaleString();
                    } else {
                        document.getElementById('update-time').innerText = 'æœ€ååŒæ­¥: ' + new Date().toLocaleString();
                    }

                    try {
                        calculateTodayQuota();
                        setRange(currentRange);
                    } catch (e) {
                        console.error("Render error:", e);
                    }
                })
                .catch(function(err) {
                    console.error(err);
                    document.getElementById('update-time').innerText = 'æ•°æ®åŒæ­¥å¤±è´¥';
                });
        }

        function calculateTodayQuota() {
            var todayStr = new Date().toISOString().split('T')[0];
            var todayRequests = rawData
                .filter(function(item) { return item.dimensions.datetime.startsWith(todayStr); })
                .reduce(function(sum, item) { return sum + item.sum.requests; }, 0);

            var percent = Math.min((todayRequests / DAILY_LIMIT) * 100, 100).toFixed(1);
            document.getElementById('quota-bar').style.width = percent + '%';
            document.getElementById('quota-percent').innerText = percent + '%';
            document.getElementById('quota-detail').innerText = todayRequests.toLocaleString() + ' / ' + DAILY_LIMIT.toLocaleString();

            if (percent > 80) document.getElementById('quota-bar').style.backgroundColor = '#ef4444';
        }

        function setRange(range) {
            currentRange = range;
            document.querySelectorAll('.btn').forEach(function(b) { b.classList.remove('active'); });

            var btns = document.querySelectorAll('.btn');
            if (range === '24h') btns[0].classList.add('active');
            if (range === '7d') btns[1].classList.add('active');
            if (range === '30d') btns[2].classList.add('active');

            var now = new Date();
            var startTime = new Date();

            if (range === '24h') startTime.setTime(now.getTime() - 24 * 60 * 60 * 1000);
            else if (range === '7d') startTime.setDate(now.getDate() - 7);
            else startTime.setDate(now.getDate() - 30);

            var filtered = rawData.filter(function(item) { return new Date(item.dimensions.datetime) >= startTime; });

            var map = {};
            filtered.forEach(function(item) {
                var d = new Date(item.dimensions.datetime);
                var key;
                if (range === '24h') {
                    // æ ¼å¼åŒ–ä¸º M/D H:00
                    key = (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':00';
                } else {
                    key = d.toISOString().split('T')[0];
                }

                if (!map[key]) map[key] = { req: 0, err: 0 };
                map[key].req += item.sum.requests;
                map[key].err += item.sum.errors;
            });

            var sortedKeys = Object.keys(map).sort(function(a, b) {
                if (range === '24h') {
                    var parseTime = function(str) {
                        var parts = str.split(' ');
                        var datePart = parts[0];
                        var timePart = parts[1];
                        var dateParts = datePart.split('/');
                        var m = dateParts[0];
                        var dd = dateParts[1];
                        var h = timePart.split(':')[0];
                        var year = new Date().getFullYear();
                        return new Date(year, m - 1, dd, h).getTime();
                    };
                    return parseTime(a) - parseTime(b);
                }
                return a.localeCompare(b);
            });

            var requests = sortedKeys.map(function(k) { return map[k].req; });
            var errors = sortedKeys.map(function(k) { return map[k].err; });

            var totalReq = requests.reduce(function(a, b) { return a + b; }, 0);
            var totalErr = errors.reduce(function(a, b) { return a + b; }, 0);
            document.getElementById('disp-req').innerText = totalReq.toLocaleString();
            document.getElementById('disp-err').innerText = totalErr.toLocaleString();

            var avg = sortedKeys.length > 0 ? Math.round(totalReq / sortedKeys.length) : 0;
            document.getElementById('disp-avg').innerText = avg.toLocaleString();

            currentLabels = sortedKeys;
            currentReqData = requests;
            currentErrData = errors;

            renderChart(sortedKeys, requests, errors, range);
        }

        function renderChart(labels, reqData, errData, range) {
            if (chartInstance) chartInstance.dispose();
            chartInstance = echarts.init(document.getElementById('chart-container'));

            // æ¯æ¬¡æ¸²æŸ“å›¾è¡¨æ—¶ï¼Œé‡æ–°è¯»å–å½“å‰çš„ data-theme
            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            var textColor = isDark ? '#f9fafb' : '#1f2937';
            var axisColor = isDark ? '#9ca3af' : '#6b7280';
            var splitLineColor = isDark ? '#374151' : '#e5e7eb';
            var tooltipBg = isDark ? '#374151' : '#ffffff';
            var tooltipBorder = isDark ? '#4b5563' : '#e5e7eb';

            var option = {
                title: { text: 'è¯·æ±‚è¶‹åŠ¿', left: 'center', textStyle: { color: textColor } },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    valueFormatter: function(value) { return Math.floor(value); },
                    backgroundColor: tooltipBg,
                    borderColor: tooltipBorder,
                    textStyle: { color: textColor }
                },
                legend: { data: ['æ€»è¯·æ±‚', 'é”™è¯¯'], bottom: 0, textStyle: { color: textColor } },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLabel: { interval: range === '30d' ? 2 : 'auto', rotate: range === '24h' ? 45 : 0, color: axisColor },
                    axisLine: { lineStyle: { color: splitLineColor } }
                },
                yAxis: {
                    type: 'value',
                    minInterval: 1,
                    axisLabel: { formatter: function(value) { return Math.floor(value); }, color: axisColor },
                    axisLine: { lineStyle: { color: splitLineColor } },
                    splitLine: { lineStyle: { color: splitLineColor } },
                    axisPointer: { label: { formatter: function(params) { return Math.floor(params.value); } } }
                },
                series: [
                    {
                        name: 'æ€»è¯·æ±‚',
                        type: 'line',
                        smooth: true,
                        data: reqData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(243, 128, 32, 0.4)' },
                                { offset: 1, color: 'rgba(243, 128, 32, 0.05)' }
                            ])
                        },
                        itemStyle: { color: '#F38020' }
                    },
                    {
                        name: 'é”™è¯¯',
                        type: 'bar',
                        data: errData,
                        itemStyle: { color: '#ef4444' }
                    }
                ]
            };
            chartInstance.setOption(option);
            if (!window.chartResizeHandler) {
                window.chartResizeHandler = function() { 
                    if (chartInstance) chartInstance.resize(); 
                };
                window.addEventListener('resize', window.chartResizeHandler);
            }
        }

        init();
    </script>
</body>
</html>
