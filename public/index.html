<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker ÁõëÊéßÈù¢Êùø</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E‚ö°%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { 
            --primary: #F38020; 
            --bg: #f3f4f6; 
            --card: #ffffff; 
            --text: #1f2937; 
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --progress-bg: #e5e7eb;
            --shadow: rgba(0,0,0,0.05);
            --btn-bg: #fff;
            --btn-hover: #f9fafb;
            --stat-value: #111827;
        }
        
        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --progress-bg: #374151;
            --shadow: rgba(0,0,0,0.3);
            --btn-bg: #374151;
            --btn-hover: #4b5563;
            --stat-value: #f9fafb;
        }
        
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .header h1 { 
            margin: 0; 
            font-size: 24px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .last-update { 
            font-size: 13px; 
            color: var(--text-secondary); 
            background: var(--border); 
            padding: 6px 12px; 
            border-radius: 20px; 
        }
        
        .theme-toggle {
            background: var(--btn-bg);
            border: 1px solid var(--border);
            padding: 8px 12px; 
            border-radius: 20px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px var(--shadow);
        }

        .quota-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
            margin-bottom: 24px; 
            border-left: 5px solid var(--primary); 
        }
        .quota-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-weight: 600; 
            font-size: 16px; 
        }
        .progress-bg { 
            height: 20px; 
            background: var(--progress-bg); 
            border-radius: 10px; 
            overflow: hidden; 
            position: relative; 
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #F38020, #f9a056); 
            width: 0%; 
            transition: width 1s ease; 
            border-radius: 10px; 
        }
        .quota-text { 
            display: flex; 
            justify-content: space-between; 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 6px; 
        }

        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { 
            border: 1px solid var(--border); 
            background: var(--btn-bg); 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            color: var(--text-secondary); 
            transition: all 0.2s; 
            box-shadow: 0 1px 2px var(--shadow); 
        }
        .btn.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 500; 
            border-color: var(--primary);
        }
        .btn:hover:not(.active) { 
            background: var(--btn-hover); 
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .stat-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
        }
        .stat-title { 
            color: var(--text-secondary); 
            font-size: 13px; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .stat-value { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--stat-value); 
        }
        .text-green { color: #10b981; } 
        .text-red { color: #ef4444; }

        #chart-container { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
            height: 450px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span style="color: var(--primary)">‚ö°</span> Cloudflare Worker ÁõëÊéß</h1>
            <div class="header-right">
                <span id="update-time" class="last-update">ËΩΩÂÖ•‰∏≠...</span>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">üåô</button>
            </div>
        </div>

        <div class="quota-card">
            <div class="quota-header">
                <span>‰ªäÊó•ËØ∑Ê±ÇÁî®Èáè (UTC)</span>
                <span id="quota-percent">0%</span>
            </div>
            <div class="progress-bg">
                <div id="quota-bar" class="progress-bar"></div>
            </div>
            <div class="quota-text">
                <span id="quota-detail">0 / 100,000</span>
                <span>ÈáçÁΩÆÊó∂Èó¥: 00:00 UTC</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn active" onclick="setRange('24h')">ÊúÄËøë 24 Â∞èÊó∂</button>
            <button class="btn" onclick="setRange('7d')">ÊúÄËøë 7 Â§©</button>
            <button class="btn" onclick="setRange('30d')">ÊúÄËøë 30 Â§©</button>
        </div>

        <div class="grid">
            <div class="stat-card">
                <div class="stat-title">Âå∫Èó¥ÊÄªËØ∑Ê±ÇÊï∞</div>
                <div class="stat-value" id="disp-req">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Âå∫Èó¥ÈîôËØØÊï∞</div>
                <div class="stat-value text-red" id="disp-err">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Âå∫Èó¥ÊÄªÊµÅÈáè</div>
                <div class="stat-value text-green" id="disp-traffic">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Âπ≥ÂùáÊØèÂ∞èÊó∂ËØ∑Ê±Ç</div>
                <div class="stat-value" id="disp-avg">-</div>
            </div>
        </div>

        <div id="chart-container"></div>
    </div>

    <script>
        // ... (‰øùÁïô‰Ω†‰πãÂâçÁöÑ ‰∏ªÈ¢òÂàáÊç¢‰ª£Á†Å ‰∏çÂèò) ...
        var currentTheme = getThemeByTime();
        function getThemeByTime() {
            var hour = new Date().getHours();
            return (hour >= 8 && hour < 20) ? 'light' : 'dark';
        }
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            var toggle = document.getElementById('theme-toggle');
            if (toggle) toggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            currentTheme = theme;
        }
        function toggleTheme() {
            var newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            if (chartInstance && currentLabels.length > 0) {
                renderChart(currentLabels, currentReqData, currentErrData, currentTrafficData, currentRange);
            }
        }
        function scheduleNextSwitch() {
            var now = new Date();
            var hour = now.getHours();
            var nextSwitchTime = new Date(now);
            var targetTheme;
            if (hour < 8) { nextSwitchTime.setHours(8, 0, 0, 0); targetTheme = 'light'; } 
            else if (hour < 20) { nextSwitchTime.setHours(20, 0, 0, 0); targetTheme = 'dark'; } 
            else { nextSwitchTime.setDate(nextSwitchTime.getDate() + 1); nextSwitchTime.setHours(8, 0, 0, 0); targetTheme = 'light'; }
            var msUntilSwitch = nextSwitchTime.getTime() - now.getTime();
            if (msUntilSwitch <= 0) msUntilSwitch = 1000; 
            setTimeout(function() {
                applyTheme(targetTheme);
                if (chartInstance) renderChart(currentLabels, currentReqData, currentErrData, currentTrafficData, currentRange);
                scheduleNextSwitch();
            }, msUntilSwitch);
        }
        applyTheme(currentTheme);
        scheduleNextSwitch();
        // ... (‰∏ªÈ¢ò‰ª£Á†ÅÁªìÊùü) ...


        // ==========================================
        // 3. Êï∞ÊçÆ‰∏éÂõæË°®ÈÄªËæë (Â∑≤‰øÆÊîπÊîØÊåÅÊµÅÈáè)
        // ==========================================
        var rawData = [];      // Â≠òÂÇ®ËØ∑Ê±ÇÊï∞ÊçÆ
        var rawTraffic = [];   // Â≠òÂÇ®ÊµÅÈáèÊï∞ÊçÆ
        var chartInstance = null;
        var currentRange = '24h';
        var currentLabels = [];
        var currentReqData = [];
        var currentErrData = [];
        var currentTrafficData = []; // Êñ∞Â¢û
        var DAILY_LIMIT = 100000;

        function init() {
            refreshData();
        }

        // Ê†ºÂºèÂåñÊµÅÈáèÂçï‰Ωç
        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 B';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function refreshData() {
            fetch('./data.json?t=' + new Date().getTime())
                .then(res => {
                    if (!res.ok) throw new Error("HTTP " + res.status);
                    return res.json();
                })
                .then(jsonResponse => {
                    // ÂÖºÂÆπÊóßÊ†ºÂºèÂíåÊñ∞Ê†ºÂºè
                    if (Array.isArray(jsonResponse)) {
                        rawData = jsonResponse;
                        rawTraffic = [];
                    } else {
                        rawData = jsonResponse.data || [];
                        rawTraffic = jsonResponse.traffic || [];
                    }

                    if (jsonResponse.updatedAt) {
                        var serverTime = new Date(jsonResponse.updatedAt);
                        document.getElementById('update-time').innerText = 'Êï∞ÊçÆÊõ¥Êñ∞‰∫é: ' + serverTime.toLocaleString();
                    } else {
                        document.getElementById('update-time').innerText = 'ÊúÄÂêéÂêåÊ≠•: ' + new Date().toLocaleString();
                    }

                    calculateTodayQuota();
                    setRange(currentRange);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('update-time').innerText = 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•';
                });
        }

        function calculateTodayQuota() {
            var todayStr = new Date().toISOString().split('T')[0];
            var todayRequests = rawData
                .filter(item => item.dimensions.datetime.startsWith(todayStr))
                .reduce((sum, item) => sum + item.sum.requests, 0);

            var percent = Math.min((todayRequests / DAILY_LIMIT) * 100, 100).toFixed(1);
            document.getElementById('quota-bar').style.width = percent + '%';
            document.getElementById('quota-percent').innerText = percent + '%';
            document.getElementById('quota-detail').innerText = todayRequests.toLocaleString() + ' / ' + DAILY_LIMIT.toLocaleString();
            
            if (percent > 80) document.getElementById('quota-bar').style.backgroundColor = '#ef4444';
            else document.getElementById('quota-bar').style.backgroundColor = ''; // ÈáçÁΩÆÈ¢úËâ≤
        }

        function setRange(range) {
            currentRange = range;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));

            var btns = document.querySelectorAll('.btn');
            if (range === '24h') btns[0].classList.add('active');
            if (range === '7d') btns[1].classList.add('active');
            if (range === '30d') btns[2].classList.add('active');

            var now = new Date();
            var startTime = new Date();

            if (range === '24h') startTime.setTime(now.getTime() - 24 * 60 * 60 * 1000);
            else if (range === '7d') startTime.setDate(now.getDate() - 7);
            else startTime.setDate(now.getDate() - 30);

            // 1. Â§ÑÁêÜËØ∑Ê±ÇÊï∞ÊçÆ
            var filteredReq = rawData.filter(item => new Date(item.dimensions.datetime) >= startTime);
            var map = {}; // key -> {req, err, traffic}

            // ËæÖÂä©ÂáΩÊï∞ÔºöÁîüÊàêÁªü‰∏ÄÁöÑÊó∂Èó¥ Key
            function getTimeKey(dateStr) {
                var d = new Date(dateStr);
                if (range === '24h') {
                    return (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':00';
                } else {
                    return d.toISOString().split('T')[0];
                }
            }

            // ËÅöÂêàËØ∑Ê±ÇÊï∞ÊçÆ
            filteredReq.forEach(item => {
                var key = getTimeKey(item.dimensions.datetime);
                if (!map[key]) map[key] = { req: 0, err: 0, bytes: 0 };
                map[key].req += item.sum.requests;
                map[key].err += item.sum.errors;
            });

            // 2. Â§ÑÁêÜÊµÅÈáèÊï∞ÊçÆ (Â¶ÇÊûúÂ≠òÂú®)
            var filteredTraffic = rawTraffic.filter(item => new Date(item.dimensions.datetime) >= startTime);
            filteredTraffic.forEach(item => {
                var key = getTimeKey(item.dimensions.datetime);
                // Ê≥®ÊÑèÔºöÂ¶ÇÊûúÊüêÊó∂ÂàªÂè™ÊúâÊµÅÈáèÊ≤°ÊúâËØ∑Ê±ÇÔºàÁΩïËßÅÔºâÔºå‰πüË¶ÅÂàùÂßãÂåñ
                if (!map[key]) map[key] = { req: 0, err: 0, bytes: 0 };
                map[key].bytes += (item.sum.edgeResponseBytes || 0);
            });

            // 3. ÊéíÂ∫è Keys
            var sortedKeys = Object.keys(map).sort((a, b) => {
                if (range === '24h') {
                    var parseTime = str => {
                        var parts = str.split(' ');
                        var dateParts = parts[0].split('/');
                        var h = parts[1].split(':')[0];
                        var year = new Date().getFullYear();
                        return new Date(year, dateParts[0] - 1, dateParts[1], h).getTime();
                    };
                    return parseTime(a) - parseTime(b);
                }
                return a.localeCompare(b);
            });

            // 4. ÁîüÊàêÊï∞ÁªÑ
            var requests = sortedKeys.map(k => map[k].req);
            var errors = sortedKeys.map(k => map[k].err);
            var traffic = sortedKeys.map(k => map[k].bytes);

            // 5. Êõ¥Êñ∞ÁªüËÆ°Âç°Áâá
            var totalReq = requests.reduce((a, b) => a + b, 0);
            var totalErr = errors.reduce((a, b) => a + b, 0);
            var totalBytes = traffic.reduce((a, b) => a + b, 0);
            
            document.getElementById('disp-req').innerText = totalReq.toLocaleString();
            document.getElementById('disp-err').innerText = totalErr.toLocaleString();
            document.getElementById('disp-traffic').innerText = formatBytes(totalBytes); // ÊòæÁ§∫Ê†ºÂºèÂåñÊµÅÈáè

            var avg = sortedKeys.length > 0 ? Math.round(totalReq / sortedKeys.length) : 0;
            document.getElementById('disp-avg').innerText = avg.toLocaleString();

            currentLabels = sortedKeys;
            currentReqData = requests;
            currentErrData = errors;
            currentTrafficData = traffic;

            renderChart(sortedKeys, requests, errors, traffic, range);
        }

        function renderChart(labels, reqData, errData, trafficData, range) {
            if (chartInstance) chartInstance.dispose();
            chartInstance = echarts.init(document.getElementById('chart-container'));

            var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            var textColor = isDark ? '#f9fafb' : '#1f2937';
            var axisColor = isDark ? '#9ca3af' : '#6b7280';
            var splitLineColor = isDark ? '#374151' : '#e5e7eb';
            var tooltipBg = isDark ? '#374151' : '#ffffff';

            var option = {
                title: { text: 'ËØ∑Ê±Ç‰∏éÊµÅÈáèË∂ãÂäø', left: 'center', textStyle: { color: textColor } },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' },
                    backgroundColor: tooltipBg,
                    textStyle: { color: textColor },
                    formatter: function (params) {
                        let res = params[0].name + '<br/>';
                        params.forEach(item => {
                            let val = item.value;
                            if (item.seriesName === 'ÊµÅÈáè') val = formatBytes(val);
                            // ‰øÆÊ≠£ÂúÜÁÇπÈ¢úËâ≤ÊòæÁ§∫
                            let marker = item.marker || `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>`;
                            res += marker + item.seriesName + ': ' + val + '<br/>';
                        });
                        return res;
                    }
                },
                legend: { 
                    data: ['ÊÄªËØ∑Ê±Ç', 'ÊµÅÈáè', 'ÈîôËØØ'], 
                    bottom: 0, 
                    textStyle: { color: textColor } 
                },
                grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true },
                xAxis: {
                    type: 'category',
                    data: labels,
                    axisLabel: { 
                        interval: range === '30d' ? 2 : 'auto', 
                        rotate: range === '24h' ? 45 : 0, 
                        color: axisColor 
                    },
                    axisLine: { lineStyle: { color: splitLineColor } }
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'ËØ∑Ê±ÇÊï∞',
                        position: 'left',
                        minInterval: 1,
                        axisLabel: { color: axisColor },
                        splitLine: { lineStyle: { color: splitLineColor } }
                    },
                    {
                        type: 'value',
                        name: 'ÊµÅÈáè',
                        position: 'right',
                        axisLabel: { 
                            color: axisColor,
                            formatter: function(value) { return formatBytes(value, 0); }
                        },
                        splitLine: { show: false } // Âè≥ËΩ¥‰∏çÊòæÁ§∫ÂàÜÂâ≤Á∫øÔºåÈò≤‰π±
                    }
                ],
                series: [
                    {
                        name: 'ÊÄªËØ∑Ê±Ç',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 0,
                        data: reqData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(243, 128, 32, 0.4)' },
                                { offset: 1, color: 'rgba(243, 128, 32, 0.05)' }
                            ])
                        },
                        itemStyle: { color: '#F38020' }
                    },
                    {
                        name: 'ÊµÅÈáè',
                        type: 'line',
                        smooth: true,
                        yAxisIndex: 1, // ‰ΩøÁî®Âè≥‰æß Y ËΩ¥
                        data: trafficData,
                        itemStyle: { color: '#10b981' }, // ÁªøËâ≤
                        lineStyle: { width: 2, type: 'dashed' } // ËôöÁ∫øÂå∫ÂàÜ
                    },
                    {
                        name: 'ÈîôËØØ',
                        type: 'bar',
                        yAxisIndex: 0,
                        data: errData,
                        itemStyle: { color: '#ef4444' }
                    }
                ]
            };
            chartInstance.setOption(option);
            if (!window.chartResizeHandler) {
                window.chartResizeHandler = () => { if (chartInstance) chartInstance.resize(); };
                window.addEventListener('resize', window.chartResizeHandler);
            }
        }

        init();
    </script>
</body>
</html>
