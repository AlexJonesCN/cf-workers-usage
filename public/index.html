<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worker ÁõëÊéßÈù¢Êùø</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E‚ö°%3C/text%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        :root { 
            --primary: #F38020; 
            --bg: #f3f4f6; 
            --card: #ffffff; 
            --text: #1f2937; 
            --text-secondary: #6b7280;
            --border: #e5e7eb;
            --progress-bg: #e5e7eb;
            --shadow: rgba(0,0,0,0.05);
            --btn-bg: #fff;
            --btn-hover: #f9fafb;
            --stat-value: #111827;
        }
        
        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f9fafb;
            --text-secondary: #9ca3af;
            --border: #374151;
            --progress-bg: #374151;
            --shadow: rgba(0,0,0,0.3);
            --btn-bg: #374151;
            --btn-hover: #4b5563;
            --stat-value: #f9fafb;
        }
        
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .header h1 { 
            margin: 0; 
            font-size: 24px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .last-update { 
            font-size: 13px; 
            color: var(--text-secondary); 
            background: var(--border); 
            padding: 6px 12px; 
            border-radius: 20px; 
        }
        
        .theme-toggle {
            background: var(--btn-bg);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            box-shadow: 0 1px 3px var(--shadow);
        }
        
        .theme-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 6px var(--shadow);
        }

        .quota-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
            margin-bottom: 24px; 
            border-left: 5px solid var(--primary); 
        }
        .quota-header { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 10px; 
            font-weight: 600; 
            font-size: 16px; 
        }
        .progress-bg { 
            height: 20px; 
            background: var(--progress-bg); 
            border-radius: 10px; 
            overflow: hidden; 
            position: relative; 
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #F38020, #f9a056); 
            width: 0%; 
            transition: width 1s ease; 
            border-radius: 10px; 
        }
        .quota-text { 
            display: flex; 
            justify-content: space-between; 
            font-size: 13px; 
            color: var(--text-secondary); 
            margin-top: 6px; 
        }

        .controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn { 
            border: 1px solid var(--border); 
            background: var(--btn-bg); 
            padding: 8px 16px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            color: var(--text-secondary); 
            transition: all 0.2s; 
            box-shadow: 0 1px 2px var(--shadow); 
        }
        .btn.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 500; 
            border-color: var(--primary);
        }
        .btn:hover:not(.active) { 
            background: var(--btn-hover); 
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 16px; 
            margin-bottom: 24px; 
        }
        .stat-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
        }
        .stat-title { 
            color: var(--text-secondary); 
            font-size: 13px; 
            margin-bottom: 8px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .stat-value { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--stat-value); 
        }
        .text-green { color: #10b981; } 
        .text-red { color: #ef4444; }

        #chart-container { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px var(--shadow); 
            height: 450px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><span style="color:var(--primary)">‚ö°</span> Cloudflare Worker ÁõëÊéß</h1>
            <div class="header-right">
                <span id="update-time" class="last-update">ËΩΩÂÖ•‰∏≠...</span>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">üåô</button>
            </div>
        </div>

        <div class="quota-card">
            <div class="quota-header">
                <span>‰ªäÊó•ËØ∑Ê±ÇÁî®Èáè (UTC)</span>
                <span id="quota-percent">0%</span>
            </div>
            <div class="progress-bg">
                <div id="quota-bar" class="progress-bar"></div>
            </div>
            <div class="quota-text">
                <span id="quota-detail">0 / 100,000</span>
                <span>ÈáçÁΩÆÊó∂Èó¥: 00:00 UTC</span>
            </div>
        </div>

        <div class="controls">
            <button class="btn active" onclick="setRange('24h')">ÊúÄËøë 24 Â∞èÊó∂</button>
            <button class="btn" onclick="setRange('7d')">ÊúÄËøë 7 Â§©</button>
            <button class="btn" onclick="setRange('30d')">ÊúÄËøë 30 Â§©</button>
        </div>

        <div class="grid">
            <div class="stat-card">
                <div class="stat-title">Âå∫Èó¥ÊÄªËØ∑Ê±ÇÊï∞</div>
                <div class="stat-value" id="disp-req">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Âå∫Èó¥ÈîôËØØÊï∞</div>
                <div class="stat-value text-red" id="disp-err">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">Âπ≥ÂùáÊØèÂ∞èÊó∂ËØ∑Ê±Ç</div>
                <div class="stat-value" id="disp-avg">-</div>
            </div>
        </div>

        <div id="chart-container"></div>
    </div>

    <script>
        // Theme Management
		const STORAGE_KEY = 'theme-preference';
		const LAST_AUTO_SWITCH_KEY = 'last-auto-switch';
		
		function getSystemTheme() {
		    const hour = new Date().getHours();
		    return (hour >= 20 || hour < 8) ? 'dark' : 'light';
		}
		
		function getCurrentTheme() {
		    const stored = localStorage.getItem(STORAGE_KEY);
		    return stored || getSystemTheme();
		}
		
		function applyTheme(theme) {
		    document.documentElement.setAttribute('data-theme', theme);
		    const toggle = document.getElementById('theme-toggle');
		    if (toggle) {
		        toggle.textContent = theme === 'dark' ?  '‚òÄÔ∏è' : 'üåô';
		    }
		}
		
		function toggleTheme() {
		    const current = document.documentElement.getAttribute('data-theme') || 'light';
		    const newTheme = current === 'dark' ? 'light' : 'dark';
		    localStorage.setItem(STORAGE_KEY, newTheme);
		    applyTheme(newTheme);
		    
		    if (chartInstance && currentLabels. length > 0) {
		        renderChart(currentLabels, currentReqData, currentErrData, currentRange);
		    }
		}
		
		function switchThemeAt(targetHour, targetTheme) {
		    const todayStr = new Date().toISOString().split('T')[0];
		    const switchPointId = `${todayStr}-${targetHour}`;
		    const lastSwitch = localStorage.getItem(LAST_AUTO_SWITCH_KEY);
		    
		    // ËØ•Êó∂Èó¥ÁÇπ‰ªäÂ§©ËøòÊ≤°ÂàáÊç¢Ëøá
		    if (lastSwitch !== switchPointId) {
		        localStorage.setItem(LAST_AUTO_SWITCH_KEY, switchPointId);
		        localStorage.setItem(STORAGE_KEY, targetTheme);
		        applyTheme(targetTheme);
		        
		        if (chartInstance && currentLabels. length > 0) {
		            renderChart(currentLabels, currentReqData, currentErrData, currentRange);
		        }
		        console.log(`Auto switched to ${targetTheme} mode`);
		    }
		}
		
		function scheduleNextSwitch() {
		    const now = new Date();
		    const hour = now.getHours();
		    
		    let nextSwitchTime = new Date(ÂΩìÂâç);
		    let targetTheme;
		    
		    // ËÆ°ÁÆó‰∏ã‰∏Ä‰∏™ÂàáÊç¢ÁÇπ
		    if (hour < 8) {
		        // ‰∏ã‰∏Ä‰∏™ÂàáÊç¢ÁÇπÊòØ‰ªäÂ§©Êó©8ÁÇπ
		        nextSwitchTime.setHours(8, 0, 0, 0);
		        targetTheme = 'light';
		    } else if (hour < 20) {
		        // ‰∏ã‰∏Ä‰∏™ÂàáÊç¢ÁÇπÊòØ‰ªäÂ§©Êôö8ÁÇπ
		        nextSwitchTime.setHours(20, 0, 0, 0);
		        targetTheme = 'dark';
		    } else {
		        // ‰∏ã‰∏Ä‰∏™ÂàáÊç¢ÁÇπÊòØÊòéÂ§©Êó©8ÁÇπ
		        nextSwitchTime.setDate(nextSwitchTime.getDate() + 1);
		        nextSwitchTime.setHours(8, 0, 0, 0);
		        targetTheme = 'light';
		    }
		    
		    // ËÆ°ÁÆóË∑ùÁ¶ª‰∏ã‰∏Ä‰∏™ÂàáÊç¢ÁÇπÁöÑÊØ´ÁßíÊï∞
		    const msUntilSwitch = nextSwitchTime. getTime() - now.getTime();
		    
		    console.log(`Next theme switch scheduled in ${Math.round(msUntilSwitch / 1000 / 60)} minutes`);
		    
		    // ËÆæÁΩÆÂÆöÊó∂Âô®ÔºåÁ≤æÂáÜÂú®ÂàáÊç¢ÁÇπËß¶Âèë
		    setTimeout(() => {
		        switchThemeAt(nextSwitchTime.getHours(), targetTheme);
		        // ÂàáÊç¢ÂÆåÊàêÂêéÔºåÂÆâÊéí‰∏ã‰∏ÄÊ¨°ÂàáÊç¢
		        scheduleNextSwitch();
		    }, msUntilSwitch);
		}
		
		// Initialize theme
		applyTheme(getCurrentTheme());
		
		// ÂêØÂä®Á≤æÂáÜÂÆöÊó∂ÂàáÊç¢
		scheduleNextSwitch();
        
        // Original script variables
        let rawData = [];
        let chartInstance = null;
        let currentRange = '24h';
        let currentLabels = [];
        let currentReqData = [];
        let currentErrData = [];
        const DAILY_LIMIT = 100000;

        function init() {
            refreshData();
        }

        function refreshData() {
            fetch('./data.json?t=' + new Date().getTime())
                .ÈîÆÔºåÁÑ∂Âêé(res => {
                    if (!res.ok) throw new ÈîôËØØ("HTTP " + res.status);
                    return res.json();
                })
                „ÄÇÈîÆÔºåÁÑ∂Âêé(jsonResponse => {
                    // üëáüëáüëá ‰øÆÊîπÁÇπÔºöÈÄÇÈÖçÊñ∞ÁöÑÊï∞ÊçÆÁªìÊûÑ üëáüëáüëá
                    // 1. Â¶ÇÊûúÊòØÊóßÊ†ºÂºè(Êï∞ÁªÑ)ÔºåÁõ¥Êé•Áî®ÔºõÂ¶ÇÊûúÊòØÊñ∞Ê†ºÂºè(ÂØπË±°)ÔºåÂèñ .data
                    rawData = Array.isArray(jsonResponse) ? jsonResponse : jsonResponse.data;
                    
                    // 2. Â§ÑÁêÜÊó∂Èó¥ÊòæÁ§∫
                    if (jsonResponse.updatedAt) {
                        const serverTime = new Date(jsonResponse.updatedAt);
                        document.getElementById('update-time').innerText = 'Êï∞ÊçÆÊõ¥Êñ∞‰∫é: ' + serverTime.toLocaleString();
                    } else {
                        // ÂÖºÂÆπÊóßÊï∞ÊçÆÔºåÊ≤°ÊúâÊó∂Èó¥Êà≥Êó∂ÊòæÁ§∫ÂΩìÂâçÊó∂Èó¥
                        document.getElementById('update-time').innerText = 'ÊúÄÂêéÂêåÊ≠•: ' + new Date().toLocaleString();
                    }
                    // üëÜüëÜüëÜ ‰øÆÊîπÁÇπÁªìÊùü üëÜüëÜüëÜ

                    try {
                        calculateTodayQuota();
                        setRange(currentRange); 
                    } catch (e) {
                        console.error("Render error:", e);
                    }
                })
                .catch(err => {
                    console„ÄÇerror(err);
                    document.getElementById('update-time').innerText = 'Êï∞ÊçÆÂêåÊ≠•Â§±Ë¥•';
                });
        }

        function calculateTodayQuota() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayRequests = rawData
                .filter(item => item.dimensions.datetime.startsWith(todayStr))
                .reduce((sum, item) => sum + item.sum.requests, 0);

            const percent = Math.min((todayRequests / DAILY_LIMIT) * 100, 100).toFixed(1);
            document.getElementById('quota-bar').style.width = percent + '%';
            document.getElementById('quota-percent').innerText = percent + '%';
            document.getElementById('quota-detail').innerText = `${todayRequests.toLocaleString()} / ${DAILY_LIMIT.toLocaleString()}`;
            
            if (percent > 80) document.getElementById('quota-bar').style.backgroundColor = '#ef4444';
        }

        function setRange(range) {
            currentRange = range;
            document.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
            
            const btns = document.querySelectorAll('.btn');
            if(range === '24h') btns[0].classList.add('active');
            if(range === '7d') btns[1].classList.add('active');
            if(range === '30d') btns[2].classList.add('active');

            const now = new Date();
            let startTime = new Date();
            
            if (range === '24h') startTime.setTime(now.getTime() - 24 * 60 * 60 * 1000);
            else if (range === '7d') startTime.setDate(now.getDate() - 7);
            else startTime.setDate(now.getDate() - 30);

            const filtered = rawData.filter(item => new Date(item.dimensions.datetime) >= startTime);

            const map = {};
            filtered.forEach(item => {
                const d = new Date(item.dimensions.datetime);
                let key;
                if (range === '24h') {
                    key = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:00`;
                } else {
                    key = d.toISOString().split('T')[0];
                }

                if (!map[key]) map[key] = { req: 0, err: 0 };
                map[key].req += item.sum.requests;
                map[key].err += item.sum.errors;
            });

            const sortedKeys = Object.keys(map).sort((a, b) => {
               if (range === '24h') {
                   const parseTime = (str) => {
                       const [datePart, timePart] = str.split(' ');
                       const [m, d] = datePart.split('/');
                       const [h] = timePart.split(':');
                       const year = new Date().getFullYear(); 
                       return new Date(year, m-1, d, h).getTime();
                   };
                   return parseTime(a) - parseTime(b);
               }
               return a.localeCompare(b);
            });

            const requests = sortedKeys.map(k => map[k].req);
            const errors = sortedKeys.map(k => map[k].err);

            const totalReq = requests.reduce((a, b) => a + b, 0);
            const totalErr = errors.reduce((a, b) => a + b, 0);
            document.getElementById('disp-req').innerText = totalReq.toLocaleString();
            document.getElementById('disp-err').innerText = totalErr.toLocaleString();
            
            const avg = sortedKeys.length > 0 ? Math.round(totalReq / sortedKeys.length) : 0;
            document.getElementById('disp-avg').innerText = avg.toLocaleString();

            // Store current chart data
            currentLabels = sortedKeys;
            currentReqData = requests;
            currentErrData = errors;

            renderChart(sortedKeys, requests, errors, range);
        }

        function renderChart(labels, reqData, errData, range) {
            if (chartInstance) chartInstance.dispose();
            chartInstance = echarts.init(document.getElementById('chart-container'));

            // Get current theme
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#f9fafb' : '#1f2937';
            const axisColor = isDark ? '#9ca3af' : '#6b7280';
            const splitLineColor = isDark ? '#374151' : '#e5e7eb';
            const tooltipBg = isDark ? '#374151' : '#ffffff';
            const tooltipBorder = isDark ? '#4b5563' : '#e5e7eb';

            const option = {
                title: { 
                    text: 'ËØ∑Ê±ÇË∂ãÂäø', 
                    left: 'center',
                    textStyle: {
                        color: textColor
                    }
                }Ôºå
                tooltip: { 
                    trigger: 'axis', 
                    axisPointer: { type: 'cross' },
                    valueFormatter: (value) => Math.floor(value),
                    backgroundColor: tooltipBg,
                    borderColor: tooltipBorder,
                    textStyle: {
                        color: textColor
                    }
                },
                legend: { 
                    data: ['ÊÄªËØ∑Ê±Ç', 'ÈîôËØØ'], 
                    bottom: 0,
                    textStyle: {
                        color: textColor
                    }
                },
                grid: { 
                    left: '3%', 
                    right: '4%', 
                    bottom: '10%', 
                    containLabel: true 
                },
                xAxis: {
                    ËæìÂÖ•: 'category',
                    data: labels,
                    axisLabel: { 
                        interval: range === '30d' ? 2 : 'auto', 
                        rotate: range === '24h' ? 45 : 0,
                        color: axisColor
                    },
                    axisLine: {
                        lineStyle: {
                            color: splitLineColor
                        }
                    }
                },
                yAxis: { 
                    type: 'value',
                    minInterval: 1,
                    axisLabel: { 
                        formatter: (value) => Math.floor(value),
                        color: axisColor
                    },
                    axisLine: {
                        lineStyle: {
                            color: splitLineColor
                        }
                    },
                    splitLine: {
                        lineStyle: {
                            color: splitLineColor
                        }
                    },
                    axisPointer: {
                        label: {
                            formatter: function(params) {
                                return Math.floor(params.value);
                            }
                        }
                    }
                },
                series: [
                    {
                        name: 'ÊÄªËØ∑Ê±Ç',
                        type: 'line',
                        smooth: true,
                        data: reqData,
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(243, 128, 32, 0.4)' },
                                { offset: 1, color: 'rgba(243, 128, 32, 0.05)' }
                            ])
                        },
                        itemStyle: { color: '#F38020' }
                    },
                    {
                        name: 'ÈîôËØØ',
                        type: 'bar',
                        data: errData,
                        itemStyle: { color: '#ef4444' }
                    }
                ]
            };
            chartInstance.setOption(option);
            if (!window.chartResizeHandler) {
                window.chartResizeHandler = () => chartInstance && chartInstance.resize();
                window.addEventListener('resize', window.chartResizeHandler);
            }
        }

        init();
    </script>
</body>
</html>

